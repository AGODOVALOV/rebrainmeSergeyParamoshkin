PGO (Profile-Guided Optimization) - это техника оптимизации кода, которая используется в компиляторе Go, чтобы улучшить производительность программ на основе профиля использования. Она позволяет компилятору Go генерировать более эффективный машинный код, который оптимизирован для конкретных профилей выполнения программы.

Профили выполнения программы предоставляют информацию о том, какие функции и методы были вызваны, сколько раз они были вызваны и как долго они выполнялись во время выполнения программы. Компилятор Go может использовать эту информацию для того, чтобы сделать более осведомленные решения об оптимизации кода.

PGO работает в два этапа. Во-первых, компилятор Go генерирует исполняемый файл с помощью стандартной оптимизации. Затем исполняемый файл запускается на реальных данных и профилируется, чтобы получить информацию о реальном использовании программы. Наконец, компилятор Go использует эту информацию для генерации нового оптимизированного исполняемого файла, который учитывает профиль использования программы.

Оптимизации, которые может использовать компилятор Go в процессе PGO, включают в себя:

- Устранение неиспользуемого кода
- Инлайнинг функций и методов
- Оптимизация памяти
- Предсказание ветвлений
- Оптимизация циклов

PGO является мощной техникой оптимизации, которая может значительно улучшить производительность программ на Go. Однако, использование PGO требует выполнения дополнительных шагов в процессе сборки, поэтому оно может быть нецелесообразным для некоторых проектов или программистов.

go build -gcflags="-N -l" -o main_no_pgo main.go;
./main_no_pgo;
go test -bench=. -run=^$ -count=20 -cpuprofile=cpu.out > no_pgo.txt;
go tool pprof -top main_no_pgo cpu.out > profile.pprof;
go build -gcflags="-N -l=4 -cpuprofile=profile.pprof" -o main_pgo main.go;
./main_pgo;
go test -bench=. -run=^$ -count=20 -cpuprofile=cpu.out > withpgo.txt;

benchstat no_pgo.txt withpgo.txt;  
